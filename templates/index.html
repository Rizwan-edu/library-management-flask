{% extends 'base.html' %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div style="text-align: center; margin-bottom: 40px; margin-top: 20px; position: relative;">
    
    <h1 style="color: #c5a059; font-size: 3.5em; font-family: 'Cinzel', serif; font-weight: 700;">
        LibraCore Dashboard
    </h1>
    <p style="color: #b0b0b0; font-style: italic; font-size: 1.4em; font-family: 'Cormorant Garamond', serif;">
        "The Central Hub of Knowledge"
    </p>

    <div style="margin-top: 30px;">
        <input type="text" id="voiceInput" placeholder="Click mic to search..." 
               style="padding: 10px; width: 300px; border-radius: 20px; border: 1px solid #c5a059; background: #1a1a1a; color: white; text-align: center;">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="mic-icon" onclick="startVoiceSearch()">
          <path d="M8.25 4.5a3.75 3.75 0 117.5 0v8.25a3.75 3.75 0 11-7.5 0V4.5z" />
          <path d="M6 10.5a.75.75 0 01.75.75v1.5a5.25 5.25 0 1010.5 0v-1.5a.75.75 0 011.5 0v1.5c0 2.9-2.354 5.25-5.25 5.25v3h3a.75.75 0 010 1.5h-9a.75.75 0 010-1.5h3v-3c-2.896 0-5.25-2.35-5.25-5.25v-1.5a.75.75 0 01.75-.75z" />
        </svg>

        <button onclick="window.location.href='/inventory?q=' + document.getElementById('voiceInput').value" 
                style="background: #c5a059; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 5px;">
            Go
        </button>
    </div>
</div>

<div class="card-container" style="margin-bottom: 50px;">
    <div class="card" style="border-top: 4px solid #4a69bd;">
        <h2>{{ total }}</h2>
        <p>Total Volumes</p>
    </div>

    <div class="card" style="border-top: 4px solid #c5a059;">
        <h2>{{ issued }}</h2>
        <p>Currently Borrowed</p>
    </div>

    <div class="card" style="border-top: 4px solid #e74c3c;">
        <h2>{{ overdue }}</h2>
        <p>Overdue Books</p>
        {% if fine > 0 %}
            <p style="color: #ff6b6b; font-weight: bold; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                Total Fines: ${{ fine }}
            </p>
        {% else %}
             <p style="color: #2ecc71; margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
                No Outstanding Fines
            </p>
        {% endif %}
    </div>
</div>

<div class="admin-only" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 40px; margin-bottom: 50px;">
    
    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border: 1px solid #333; width: 400px;">
        <h3 style="color: #c5a059; text-align: center; font-family: 'Cinzel', serif; margin-bottom: 20px;">Library Composition</h3>
        <canvas id="categoryChart"></canvas>
    </div>

    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border: 1px solid #333; width: 400px;">
        <h3 style="color: #c5a059; text-align: center; font-family: 'Cinzel', serif; margin-bottom: 20px;">Inventory Status</h3>
        <canvas id="statusChart"></canvas>
    </div>

</div>

<div style="text-align: center; margin-top: 40px;">
    <a href="{{ url_for('inventory') }}" class="btn">
        ðŸ“š Enter Vault & Manage Inventory
    </a>
</div>

<script>
    function startVoiceSearch() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Sorry, your browser doesn't support Voice Search. Try Chrome!");
            return;
        }
        var recognition = new webkitSpeechRecognition();
        recognition.lang = "en-US";
        recognition.start();
        document.getElementById("voiceInput").placeholder = "Listening...";
        recognition.onresult = function(event) {
            var transcript = event.results[0][0].transcript;
            document.getElementById("voiceInput").value = transcript;
            window.location.href = '/inventory?q=' + transcript;
        };
        recognition.onerror = function(event) {
             document.getElementById("voiceInput").placeholder = "Error. Try again.";
        };
    }
</script>

<script>
    // 1. Category Chart
    const catCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(catCtx, {
        type: 'doughnut',
        data: {
            labels: {{ chart_labels | tojson }},
            datasets: [{
                data: {{ chart_values | tojson }},
                backgroundColor: [
                    '#c5a059', '#4a69bd', '#e74c3c', '#2ecc71', '#9b59b6', '#f1c40f', '#34495e', '#ecf0f1', '#e67e22'
                ],
                borderColor: '#0d0d0d',
                borderWidth: 2
            }]
        },
        options: {
            plugins: {
                legend: { labels: { color: '#ccc', font: {family: 'Cinzel'} } }
            }
        }
    });

    // 2. Status Chart
    const statCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statCtx, {
        type: 'bar',
        data: {
            labels: ['Available Books', 'Issued Books'],
            datasets: [{
                label: 'Count',
                data: [{{ available }}, {{ issued }}],
                backgroundColor: ['#2ecc71', '#c0392b'],
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#ccc' } },
                x: { grid: { display: false }, ticks: { color: '#ccc', font: {family: 'Cinzel'} } }
            },
            plugins: { legend: { display: false } }
        }
    });
</script>
{% endblock %}